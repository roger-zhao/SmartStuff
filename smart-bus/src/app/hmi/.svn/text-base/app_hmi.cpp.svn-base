/*
 * app_hmi.cpp
 *
 *  Created on: Jun 1, 2015
 *      Author: ZhaoYJ 
 */
#include "app_hmi.h"


#ifdef SELF_TEST
U8 stationFonts[2*XINXI_MENU_TOTAL_MODREG] = {

/* 大(0) 雁(1) 塔(2) 南(3) 广(4) 场(5) 北(6) 口(7)*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x80,0x00,
    0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,
    0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x18,0x00,0x01,0x80,0x3C,0x1F,0xFF,0xFF,0xC0,
    0x00,0x01,0x80,0x00,0x00,0x03,0x80,0x00,0x00,0x03,0x80,0x00,0x00,0x03,0x40,0x00,
    0x00,0x03,0x40,0x00,0x00,0x03,0x60,0x00,0x00,0x06,0x20,0x00,0x00,0x06,0x30,0x00,
    0x00,0x06,0x10,0x00,0x00,0x0C,0x18,0x00,0x00,0x0C,0x0C,0x00,0x00,0x18,0x06,0x00,
    0x00,0x30,0x07,0x00,0x00,0x60,0x03,0x80,0x00,0xC0,0x01,0xE0,0x01,0x80,0x00,0xF8,
    0x03,0x00,0x00,0x7C,0x0C,0x00,0x00,0x10,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"大",0*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x04,0x00,0x00,0x38,
    0x07,0xFF,0xFF,0xFC,0x06,0x08,0x40,0x00,0x06,0x0C,0x64,0x00,0x06,0x18,0x67,0x00,
    0x06,0x18,0xC3,0x00,0x06,0x10,0xC3,0x10,0x06,0x30,0x80,0x30,0x06,0x21,0xFF,0xF8,
    0x06,0x71,0x86,0x00,0x06,0x73,0x86,0x00,0x06,0xB3,0x86,0x00,0x06,0xB5,0x86,0x20,
    0x07,0x39,0xFF,0xF0,0x06,0x39,0x86,0x00,0x06,0x31,0x86,0x00,0x06,0x31,0x86,0x00,
    0x04,0x31,0x86,0x20,0x04,0x31,0xFF,0xF0,0x0C,0x31,0x86,0x00,0x0C,0x31,0x86,0x00,
    0x08,0x31,0x86,0x00,0x18,0x31,0x86,0x00,0x10,0x31,0x86,0x18,0x10,0x31,0xFF,0xFC,
    0x20,0x31,0x80,0x00,0x20,0x31,0x80,0x00,0x40,0x31,0x00,0x00,0x00,0x00,0x00,0x00,/*"雁",1*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x01,0x00,0x00,0x03,0x01,0x81,0x80,
    0x03,0x01,0x81,0x00,0x03,0x01,0x81,0x08,0x03,0x01,0x81,0x1C,0x03,0x1F,0xFF,0xE0,
    0x03,0x01,0x81,0x00,0x03,0x21,0x99,0x00,0x03,0x71,0xB9,0x00,0x3F,0x80,0x78,0x00,
    0x03,0x00,0x64,0x00,0x03,0x00,0xC2,0x00,0x03,0x01,0x81,0x80,0x03,0x03,0x00,0xE0,
    0x03,0x06,0x01,0x78,0x03,0x08,0x01,0xBC,0x03,0x11,0xFE,0x40,0x03,0x60,0x00,0x00,
    0x03,0x00,0x00,0x00,0x03,0x13,0xFF,0xC0,0x03,0xE3,0x00,0xC0,0x07,0x03,0x00,0xC0,
    0x7C,0x03,0x00,0xC0,0x30,0x03,0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0xFF,0xC0,
    0x00,0x03,0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x02,0x00,0x80,0x00,0x00,0x00,0x00,/*"塔",2*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x80,0x00,
    0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x10,0x00,0x01,0x80,0x38,0x3F,0xFF,0xFF,0xFC,
    0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x07,0xFF,0xFF,0xF0,
    0x06,0x00,0x20,0x60,0x06,0x10,0x18,0x60,0x06,0x18,0x38,0x60,0x06,0x0C,0x30,0x60,
    0x06,0x0C,0x60,0x60,0x06,0x04,0x44,0x60,0x06,0x7F,0xFE,0x60,0x06,0x01,0x80,0x60,
    0x06,0x01,0x80,0x60,0x06,0x01,0x86,0x60,0x07,0xFF,0xFF,0x60,0x06,0x01,0x80,0xE0,
    0x06,0x01,0x80,0x60,0x06,0x01,0x80,0x60,0x06,0x01,0x80,0x60,0x06,0x01,0x88,0x60,
    0x06,0x01,0x87,0xE0,0x06,0x01,0x01,0xC0,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,/*"南",3*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0xC0,0x00,
    0x00,0x00,0xC0,0x00,0x00,0x00,0xC0,0x10,0x04,0x00,0x40,0x38,0x07,0xFF,0xFF,0xFC,
    0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,
    0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,
    0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,
    0x06,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x0C,0x00,0x00,0x00,
    0x0C,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x10,0x00,0x00,0x00,
    0x20,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"广",4*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x03,0x80,0x01,0x80,
    0x03,0x87,0xFF,0xC0,0x03,0x00,0x03,0x80,0x03,0x00,0x07,0x00,0x03,0x00,0x0E,0x00,
    0x03,0x00,0x18,0x00,0x03,0x00,0x30,0x00,0x03,0x18,0x60,0x00,0x3F,0xFC,0xC0,0x00,
    0x03,0x01,0x80,0x00,0x03,0x07,0x00,0x18,0x03,0x07,0xFF,0xFC,0x03,0x00,0x33,0x18,
    0x03,0x00,0x63,0x18,0x03,0x00,0x63,0x18,0x03,0x00,0xC2,0x18,0x03,0x04,0xC6,0x18,
    0x03,0x19,0x86,0x18,0x03,0x61,0x0C,0x10,0x03,0x83,0x0C,0x10,0x0F,0x06,0x18,0x30,
    0x7C,0x08,0x30,0x30,0x30,0x30,0x60,0x30,0x00,0x00,0xC0,0x30,0x00,0x01,0x80,0x70,
    0x00,0x06,0x0F,0xE0,0x00,0x0C,0x01,0xE0,0x00,0x30,0x00,0x80,0x00,0x00,0x00,0x00,/*"场",5*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x20,0x00,0x00,0x1C,0x38,0x00,
    0x00,0x18,0x30,0x00,0x00,0x18,0x30,0x00,0x00,0x18,0x30,0x00,0x00,0x18,0x30,0x00,
    0x00,0x18,0x30,0x00,0x00,0x18,0x30,0x10,0x00,0x18,0x30,0x38,0x3F,0xF8,0x30,0x70,
    0x00,0x18,0x31,0xC0,0x00,0x18,0x33,0x00,0x00,0x18,0x3C,0x00,0x00,0x18,0x30,0x00,
    0x00,0x18,0x30,0x00,0x00,0x18,0x30,0x00,0x00,0x18,0x30,0x00,0x00,0x18,0x30,0x00,
    0x00,0x18,0x30,0x00,0x00,0x18,0x30,0x08,0x00,0x18,0x30,0x08,0x00,0xF8,0x30,0x08,
    0x07,0x18,0x30,0x08,0x3C,0x18,0x30,0x08,0x10,0x18,0x30,0x08,0x00,0x18,0x30,0x1C,
    0x00,0x18,0x3F,0xFC,0x00,0x18,0x07,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"北",6*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x40,0x03,0xFF,0xFF,0xE0,
    0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,
    0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,
    0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,
    0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,
    0x03,0xFF,0xFF,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x03,0x00,0x00,0x80,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"口",7*/
    /* 万(0) 科(1) 城(2) 樱(5) 花(6) 二(7) 路(8) 口(9)*/
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x70,0x00,0x00,0x00,0xF8,0x3F,0xFF,0xFF,0xFC,0x00,0x0E,0x00,0x00,
    0x00,0x0F,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x0E,0x03,0x80,
    0x00,0x0F,0xFF,0xC0,0x00,0x0E,0x03,0x80,0x00,0x0C,0x03,0x80,0x00,0x1C,0x03,0x80,
    0x00,0x1C,0x03,0x80,0x00,0x1C,0x03,0x80,0x00,0x18,0x03,0x00,0x00,0x38,0x07,0x00,
    0x00,0x38,0x07,0x00,0x00,0x70,0x07,0x00,0x00,0xE0,0x07,0x00,0x00,0xC0,0x07,0x00,
    0x01,0x84,0x0E,0x00,0x07,0x03,0xFE,0x00,0x0C,0x00,0x7C,0x00,0x30,0x00,0x30,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"万",0*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x03,0x80,
    0x00,0xF8,0x03,0xC0,0x07,0xFC,0x03,0x80,0x3F,0x81,0x83,0x80,0x01,0x80,0xE3,0x80,
    0x01,0x80,0x73,0x80,0x01,0x98,0x73,0x80,0x01,0xBC,0x33,0x80,0x7F,0xFE,0x03,0x80,
    0x03,0x81,0x03,0x80,0x03,0x81,0xC3,0x80,0x07,0xF0,0xE3,0x80,0x07,0xBC,0x73,0x80,
    0x0F,0x9C,0x63,0x9C,0x0D,0x88,0x03,0xBE,0x19,0x80,0x03,0xF8,0x31,0x80,0xFF,0x80,
    0x61,0x9F,0x03,0x80,0x41,0x80,0x03,0x80,0x81,0x80,0x03,0x80,0x01,0x80,0x03,0x80,
    0x01,0x80,0x03,0x80,0x01,0x80,0x03,0x80,0x01,0x80,0x03,0x80,0x01,0x80,0x03,0x80,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"科",1*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x00,
    0x07,0x00,0x0D,0xC0,0x06,0x00,0x0C,0xE0,0x06,0x00,0x0C,0x60,0x06,0x00,0x0C,0x50,
    0x06,0x18,0x0C,0x38,0x06,0x1F,0xFF,0xFC,0x06,0xD8,0x0C,0x00,0x7F,0xF8,0x0C,0x00,
    0x06,0x18,0xCC,0x40,0x06,0x1F,0xEC,0x78,0x06,0x18,0xCC,0x70,0x06,0x18,0xCC,0x60,
    0x06,0x18,0xCE,0xE0,0x06,0x18,0xC6,0xE0,0x06,0x38,0xC6,0xC0,0x07,0xD0,0xC7,0xC0,
    0x3F,0x30,0xC7,0x80,0x7C,0x37,0xC3,0x04,0x70,0x31,0x87,0x84,0x20,0x61,0x0F,0xC8,
    0x00,0x40,0x1D,0xE8,0x00,0xC0,0x30,0xF8,0x01,0x80,0xC0,0x78,0x03,0x01,0x00,0x1C,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"城",2*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x00,0x80,0x10,
    0x06,0x3F,0xEF,0xFC,0x06,0x30,0xCC,0x18,0x06,0x30,0xCC,0x18,0x06,0x37,0xCD,0x98,
    0x06,0xF6,0xCD,0x98,0xFF,0xF6,0xCD,0x98,0x06,0x36,0xCD,0x98,0x0E,0x36,0xCD,0x98,
    0x0F,0x36,0xCD,0x98,0x0E,0xC6,0x01,0x80,0x0E,0x6D,0xC3,0x70,0x1E,0x68,0xE6,0x38,
    0x1E,0x10,0x4C,0x18,0x1E,0x20,0xF0,0x30,0x36,0xC0,0xC0,0x38,0x36,0xFF,0xFF,0xFC,
    0x66,0x01,0x87,0x00,0x46,0x03,0x07,0x00,0x86,0x07,0x0E,0x00,0x06,0x03,0xFC,0x00,
    0x06,0x00,0x3F,0x00,0x06,0x00,0x77,0xC0,0x06,0x03,0xC1,0xE0,0x06,0x1E,0x00,0x60,
    0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"樱",5*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x70,0x3C,0x00,
    0x00,0x60,0x38,0x00,0x00,0x60,0x38,0x30,0x00,0x60,0x38,0x78,0xFF,0xFF,0xFF,0xFC,
    0x00,0x60,0x38,0x00,0x00,0x60,0x38,0x00,0x00,0x60,0x38,0x00,0x00,0xC0,0x30,0x00,
    0x00,0xE0,0xC0,0x00,0x01,0xC0,0xF0,0x80,0x03,0x80,0xE1,0xC0,0x03,0x00,0xE1,0xE0,
    0x07,0xC0,0xE7,0x80,0x0D,0x80,0xEF,0x00,0x19,0x80,0xFE,0x00,0x31,0x80,0xF8,0x00,
    0x61,0x80,0xE0,0x08,0x81,0x83,0xE0,0x08,0x01,0x8E,0xE0,0x08,0x01,0xB0,0xE0,0x08,
    0x01,0x80,0xE0,0x1C,0x01,0x80,0xE0,0x1E,0x01,0x80,0xFF,0xFE,0x01,0x80,0x7F,0xF8,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"花",6*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x1E,
    0x00,0x7F,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x03,
    0x03,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"二",7*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,
    0x00,0x81,0x81,0xC0,0x00,0xFF,0xC3,0x80,0x00,0xC1,0x83,0x07,0x00,0xC1,0x83,0xFF,
    0x00,0xC1,0x82,0x06,0x00,0xC1,0x86,0x0E,0x00,0xC1,0x85,0x1C,0x00,0xFF,0x8D,0x1C,
    0x00,0xC1,0x88,0xB8,0x00,0x8C,0x10,0xF0,0x00,0x0C,0x00,0xF0,0x00,0xCC,0x01,0xFC,
    0x00,0xCD,0xC3,0x9F,0x00,0xCF,0xE6,0x07,0x00,0xCC,0x1C,0x05,0x00,0xCC,0x27,0xFF,
    0x00,0xCC,0x06,0x06,0x00,0xCC,0x06,0x06,0x00,0xCC,0x06,0x06,0x00,0xCC,0x06,0x06,
    0x00,0xCD,0xE6,0x06,0x00,0xFE,0x06,0x06,0x03,0xF0,0x07,0xFE,0x03,0x00,0x06,0x06,
    0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"路",8*/

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x1C,0x00,0x3F,0xFF,0xFE,
    0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,
    0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,
    0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,
    0x00,0x38,0x00,0x1C,0x00,0x3F,0xFF,0xFC,0x00,0x38,0x00,0x1C,0x00,0x38,0x00,0x1C,
    0x00,0x38,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"口",9*/
};

#endif

HmiApp::HmiApp()
{
    this->pcAdp = new HmiAdp(MODREG_END);
}

HmiApp::~HmiApp()
{
    delete this->pcAdp; 
}

void HmiApp::init()
{

    DBG(DBG_INFO, "enter HmiApp init!");
    eRet ret = eOK;

    // init DB
    //
#ifdef SELF_TEST 

    this->setBBBReady(1);
    // bus infos
    this->setStationFont(stationFonts);
#endif
    this->setBusNum(413);
    this->setDriverId(38);
    this->setAPCVal(2);
    // commInfos 
    commInfo ci;
    ci.weather = 3;
    ci.temperature = 39;
    ci.humidity = 78;
    ci.ultraViolet = 2;
    this->setCommInfo(ci);
    // init adapter
    // data server
    ret = this->pcAdp->dataServerInit();
    ASSERT(eOK == ret);
    // initial states
    //
    // wait for BBB & HISI board on 
    // sync with HMI board: time-sync
    // main will set BBBReady for hmiapp
    while(!this->getBBBReady())
    {
        DBG(DBG_WARN, " getBBBReady not ok!")
        sleep(2);
    }

    ret = this->pcAdp->setVal(BBB_READY_MODREG, BBBREADY);
    ASSERT(eOK == ret);

    // create & start timer for refresh
    U32 startTime = NOW + 10;
    U32 period = CRITICAL_INFO_REFRESH_INTERVAL;
    this->pCriticalTimer = new OsTimer(startTime, period, HmiApp::refreshCriticalInfos, (void *)this);
    ret = this->pCriticalTimer->start();
    ASSERT(eOK == ret);

    startTime = ONE_SEC;
    period = NON_CRITICAL_INFO_REFRESH_INTERVAL;
    this->pNonCriticalTimer = new OsTimer(startTime, period, HmiApp::refreshNonCriticalInfos, (void *)this);
    ret = this->pNonCriticalTimer->start();
    ASSERT(eOK == ret);
}

void HmiApp::run()
{
    eRet ret = eFail;
    U8 always = 1;
    U16 Hmilogin = 0;
    U16 loginRegVal = 0;

    DBG(DBG_INFO, "enter HmiApp run!");
    while(always)    
    {
        // data server
        ret = this->pcAdp->dataServerRun();
        ASSERT(eOK == ret);
        // DBG(DBG_INFO, "runing!");
        

        //

        if(!Hmilogin)
        {
            // HMI login
            ret = this->pcAdp->getVal(LOGIN_MODREG, &loginRegVal);
            ASSERT(eOK == ret);
            
            if(LOGIN_REQ == loginRegVal)
            {
                ret = this->pcAdp->setVal(LOGIN_MODREG, LOGIN_RES);
                ASSERT(eOK == ret);
                // finish HMI login 
                Hmilogin = 1;
            }
        }
        else
        {
            // re-login?
            // HMI login
            ret = this->pcAdp->getVal(LOGIN_MODREG, &loginRegVal);
            ASSERT(eOK == ret);
            
            if(LOGIN_REQ == loginRegVal)
            {
                ret = this->pcAdp->setVal(LOGIN_MODREG, LOGIN_RES);
                ASSERT(eOK == ret);
                // finish HMI login 
                Hmilogin++;
                DBG(DBG_WARN, "HMI board re-login: %d!", Hmilogin);
            }

            // data-exchange with HMI board:
            // real-time: manually station infos (get manual stations)
            U16 manualStation = 0xff; 
            ret = this->pcAdp->getVal(MANUAL_CURR_STATION_MODREG, &manualStation);
            ASSERT(eOK == ret);
            this->setManualNextStation(manualStation);
        }
    }
}

void HmiApp::stop()
{
    eRet ret = eFail;
    DBG(DBG_INFO, "enter HmiApp stop!");
    // delete DB
    //
    // destroy timers
    ret = this->pCriticalTimer->destroy();
    ASSERT(eOK == ret);
    ret = this->pNonCriticalTimer->destroy();
    ASSERT(eOK == ret);

    // delete dataserver
    ret = this->pcAdp->dataServerStop();
    ASSERT(eOK == ret);
}

